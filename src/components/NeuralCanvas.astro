---
// On load: black → tiny points fade in → constellation slowly forms.
// Progressive opacity: points first, then full scene.
// When containToHero is true, canvas is absolute so it only fills the hero and scrolls away with it.
interface Props { containToHero?: boolean; }
const { containToHero = false } = Astro.props;
---

<div class="canvas-wrap" class:list={[{ 'contain-to-hero': containToHero }]} aria-hidden="true">
  <div class="canvas-cover" id="canvas-cover"></div>
  <div class="canvas-fallback">
    <div class="grid-bg"></div>
  </div>
  <div id="neural-mount" class="neural-mount"></div>
</div>

<style>
  .canvas-wrap {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    background: #000;
  }
  .canvas-wrap.contain-to-hero {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }
  .canvas-cover {
    position: absolute;
    inset: 0;
    background: #000;
    z-index: 2;
    opacity: 1;
    transition: opacity 1.8s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
  }
  .canvas-cover.faded {
    opacity: 0;
    pointer-events: none;
  }
  .canvas-fallback {
    position: absolute;
    inset: 0;
    background: #0a0a0c;
  }
  .grid-bg {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
    background-size: 64px 64px;
    opacity: 0;
    transition: opacity 1s 0.5s;
  }
  .neural-mount {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 2.2s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
  }
  .neural-mount.ready {
    opacity: 1;
    pointer-events: auto;
  }
  .neural-mount canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
  @media (prefers-reduced-motion: reduce) {
    .canvas-cover, .neural-mount { transition: opacity 0.5s; }
  }
</style>

<script>
  (function () {
    var mount = document.getElementById('neural-mount');
    var cover = document.getElementById('canvas-cover');
    if (!mount) return;
    function loadScene() {
      import('./NeuralScene.ts').then(function (m) {
        m.initNeuralScene(mount).then(function () {
          mount.classList.add('ready');
          if (cover) setTimeout(function () { cover.classList.add('faded'); }, 200);
          try { window.dispatchEvent(new CustomEvent('neuralready')); } catch (e) {}
        }).catch(function (err) {
          console.error('[NeuralScene] init failed', err);
          mount.classList.add('ready');
          if (cover) cover.classList.add('faded');
        });
      }).catch(function (err) {
        console.error('[NeuralScene] load failed', err);
        mount.classList.add('ready');
        if (cover) cover.classList.add('faded');
      });
    }
    if (document.readyState === 'complete') loadScene();
    else window.addEventListener('load', loadScene);
  })();
</script>
